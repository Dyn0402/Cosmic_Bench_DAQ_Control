#!/bin/bash

# Usage:
#   ./transfer_all_runs.sh /source/base /dest/base
#   ./transfer_all_runs.sh --range 15 50 /source/base /dest/base
#
# Range only works with directories named run_<number>

# --- Parse optional range arguments ---
RANGE_START=""
RANGE_END=""

if [[ "$1" == "--range" ]]; then
    RANGE_START="$2"
    RANGE_END="$3"
    shift 3
fi

BASE_PATH="$1"
DEST_BASE="$2"

if [[ -z "$BASE_PATH" || -z "$DEST_BASE" ]]; then
    echo "Usage:"
    echo "  $0 /source/base /dest/base"
    echo "  $0 --range 15 50 /source/base /dest/base"
    exit 1
fi

USER="dn277127"
JUMP1="dn277127@daplxa.extra.cea.fr"
TARGET="dn277127@feynman"

LOG="transfer_runs.log"

echo "=== Transfer started at $(date) ===" | tee -a "$LOG"
echo "Base path: $BASE_PATH" | tee -a "$LOG"

RSYNC_OPTS="-av --partial --inplace --append-verify --progress"

SSH_CMD="ssh -o ProxyJump=$JUMP1"

# --- Select directories ---
RUN_DIRS=()

if [[ -n "$RANGE_START" ]]; then
    # Range mode
    echo "Using range: $RANGE_START to $RANGE_END" | tee -a "$LOG"

    for ((i=RANGE_START; i<=RANGE_END; i++)); do
        DIR="$BASE_PATH/run_$i"
        if [[ -d "$DIR" ]]; then
            RUN_DIRS+=("$DIR")
        else
            echo "Skipping missing directory: $DIR" | tee -a "$LOG"
        fi
    done
else
    # Default: all run_* directories
    RUN_DIRS=( "$BASE_PATH"/run_* )
fi

# --- Transfer each directory ---
for RUN_DIR in "${RUN_DIRS[@]}"; do
    RUN_NAME=$(basename "$RUN_DIR")
    DEST="$TARGET:$DEST_BASE/$RUN_NAME"

    echo "----- Transferring $RUN_NAME -----" | tee -a "$LOG"

    # Retry loop
    while true; do
        rsync $RSYNC_OPTS -e "$SSH_CMD" "$RUN_DIR/" "$DEST/"
        STATUS=$?

        if [[ $STATUS -eq 0 ]]; then
            echo "Completed: $RUN_NAME" | tee -a "$LOG"
            break
        else
            echo "Rsync interrupted (status $STATUS). Retrying in 10 seconds..." | tee -a "$LOG"
            sleep 10
        fi
    done
done

echo "=== Transfer finished at $(date) ===" | tee -a "$LOG"
