#!/bin/bash

###############################
# CONFIGURABLE PARAMETERS
###############################

# Rate limit for rsync (examples: "10m", "50m", "100m", "500k")
# Set empty ("") for unlimited
MAX_RATE="20m"  # 20 MB/s


###############################
# SCRIPT STARTS HERE
###############################

# Usage:
#   ./transfer_all_runs.sh /source/base /dest/base
#   ./transfer_all_runs.sh --range 15 50 /source/base /dest/base

# Parse optional range
RANGE_START=""
RANGE_END=""

if [[ "$1" == "--range" ]]; then
    RANGE_START="$2"
    RANGE_END="$3"
    shift 3
fi

BASE_PATH="$1"
DEST_BASE="$2"

if [[ -z "$BASE_PATH" || -z "$DEST_BASE" ]]; then
    echo "Usage:"
    echo "  $0 /source/base /dest/base"
    echo "  $0 --range 15 50 /source/base /dest/base"
    exit 1
fi

USER="dn277127"
JUMP1="dn277127@daplxa.extra.cea.fr"
TARGET="dn277127@feynman:$DEST_BASE"

LOG="transfer_runs.log"

echo
echo "=== Transfer started at $(date) ===" | tee -a "$LOG"
echo "Base path: $BASE_PATH" | tee -a "$LOG"

SSH_CMD="ssh -o ProxyJump=$JUMP1"

# Base rsync options
RSYNC_OPTS="-av --partial --inplace --append-verify --progress"

# Add rate limit if set
if [[ -n "$MAX_RATE" ]]; then
    RSYNC_OPTS="$RSYNC_OPTS --bwlimit=$MAX_RATE"
    echo "Rate limit: $MAX_RATE" | tee -a "$LOG"
else
    echo "Rate limit: NONE" | tee -a "$LOG"
fi


# Build the list of directories for ONE big rsync
RUN_DIRS=()

if [[ -n "$RANGE_START" ]]; then
    echo "Using run range: $RANGE_START to $RANGE_END" | tee -a "$LOG"

    for ((i=RANGE_START; i<=RANGE_END; i++)); do
        DIR="$BASE_PATH/run_$i"
        if [[ -d "$DIR" ]]; then
            RUN_DIRS+=("$DIR")
        else
            echo "Skipping missing directory: $DIR" | tee -a "$LOG"
        fi
    done
else
    for DIR in "$BASE_PATH"/run_*; do
        [[ -d "$DIR" ]] && RUN_DIRS+=("$DIR")
    done
fi

if [[ ${#RUN_DIRS[@]} -eq 0 ]]; then
    echo "No run directories found!"
    exit 1
fi

echo "Transferring ${#RUN_DIRS[@]} directories in one rsync..." | tee -a "$LOG"
printf '  %s\n' "${RUN_DIRS[@]}" | tee -a "$LOG"

# Single rsync â†’ only one password prompt
rsync $RSYNC_OPTS -e "$SSH_CMD" "${RUN_DIRS[@]}" "$TARGET"

STATUS=$?

if [[ $STATUS -eq 0 ]]; then
    echo "=== Transfer finished successfully at $(date) ===" | tee -a "$LOG"
else
    echo "=== Transfer ended with error status $STATUS at $(date) ===" | tee -a "$LOG"
fi
